tupvar_metatable = {
	__tostring = function(self)
		return table.concat(self, ' ')
	end,
	__concat = function(first, second)
		if type(first) == 'table' and type(second) == 'table'
		then 
			local output = tupvar{}
			for index, value in ipairs(first) do table.insert(output, value) end
			for index, value in ipairs(second) do table.insert(output, value) end
			return output
		end
		return tostring(first) .. tostring(second)
	end,
	__index = table
}
tupvar = function(contents)
	if not contents then contents = {} end
	setmetatable(contents, tupvar_metatable)
	return contents
end

tuparray_metatable = { 
	__index = function(table, key) 
		rawset(table, key, tupvar{})
		return rawget(table, key) 
	end 
}
tuparray = function(contents)
	if not contents then contents = {} end
	setmetatable(contents, tuparray_metatable)
	return contents
end

creategitignore()

pages = tupvar{}
examples = tupvar{}
flags = tupvar{}
flags_specific = tuparray{}

if getconfig('TUP_WWW') == 'y'
then
	pages:insert 'index.html'
	pages:insert 'getting_started.html'
	pages:insert 'examples.html'
	pages:insert 'manual.html'
	pages:insert 'tips_and_tricks.html'
	pages:insert 'make_vs_tup.html'
	pages:insert 'tup_vs_mordor.html'
	pages:insert 'license.html'
	pages:insert 'support.html'

	examples:insert 'ex_a_first_tupfile.html'
	examples:insert 'ex_dependencies.html'
	examples:insert 'ex_generated_header.html'
	examples:insert 'ex_multiple_directories.html'

	-- Use the 'examples' sub-menu for the examples page.
	flags_specific['examples']:insert '-x'

	if getconfig('TUP_WWW_ANALYTICS') == 'y'
	then
		flags:insert '-a'
	end

	rule(nil, '^ GEN %o^ ./gen_menu.sh $(pages) > %o', 'menu.inc')
	rule(nil, '^ GEN %o^ ./gen_ex_header.sh $(examples) > %o', 'examples.inc')
	rule('examples.inc', '^ GEN %o^ ./gen_menu.sh -x $(pages) > %o', 'menu-examples.inc')
	rule(nil, '^ GEN %o^ ./gen_examples.sh $(examples) > %o', 'examples.html')
	rule('../../tup.1', '^ man2html %o^ man2html %f > %o', 'manual.html')
	for index, page in ipairs(pages)
	do
		rule(
			{page, 'menu.inc', 'menu-examples.inc'}, 
			'^ GEN %o^ ./gen_page.sh $(flags) ' .. 
				' ' .. table.concat(flags_specific[string.gsub(page, '%..*', '')], ' ') .. 
				' ' .. page .. ' > %o', 
			page .. '.gen')
	end
	for index, example in ipairs(examples)
	do
		local outputs = {example .. '.gen'}
		definerule {
			inputs = {example, 'menu-examples.inc'},
			outputs = outputs,
			command = '^ GEN ' .. outputs[1] .. '^' ..
				'./gen_page.sh $(flags) ' ..
				' -x ' .. example .. ' > ' .. outputs[1]
		}
	end
end
